<!DOCTYPE html>
<html>
  <head>
    <title>ãƒŸãƒ­ã‚¹ãƒˆãƒ«æŠ€è¡“ç¤¾ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
      /**
       * MQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
       * @param {Object} options
       * @param {string} options.brokerUrl
       * @param {string} options.username
       * @param {string} options.password
       * @param {string} options.clientId
       * @returns {Object}
       */
      function createMQTTClient({ brokerUrl, username, password, clientId }) {
        const client = mqtt.connect(brokerUrl, {
          username: username,
          password: password,
          clientId: clientId,
          clean: true,
          reconnectPeriod: 1000
        });

        client.on("connect", () => {
          console.log("âœ… MQTTæ¥ç¶šæˆåŠŸ");
        });

        client.on("error", (err) => {
          console.error("âŒ MQTTã‚¨ãƒ©ãƒ¼:", err);
        });

        client.on("reconnect", () => {
          console.log("ğŸ”„ å†æ¥ç¶šä¸­...");
        });

        return {
          client, // å¤–ã‹ã‚‰æ¥ç¶šå®Œäº†ã‚’ç›£è¦–ã§ãã‚‹ã‚ˆã†ã« client ã‚’è¿”ã™

          subscribe(topic, callback) {
            client.subscribe(topic, (err) => {
              if (err) {
                console.error("âŒ è³¼èª­å¤±æ•—:", err);
              } else {
                console.log("ğŸ“¡ è³¼èª­æˆåŠŸ:", topic);
              }
            });

            client.on("message", (recvTopic, message) => {
              if (recvTopic === topic) {
                callback(message.toString(), recvTopic);
              }
            });
          },

          publish(topic, message) {
            client.publish(topic, message, {}, (err) => {
              if (err) {
                console.error("âŒ ç™ºè¡Œå¤±æ•—:", err);
              } else {
                console.log("ğŸ“¤ ç™ºè¡ŒæˆåŠŸ:", topic, message);
              }
            });
          },

          disconnect() {
            client.end();
            console.log("ğŸ”Œ åˆ‡æ–­ã—ã¾ã—ãŸ");
          }
        };
      }
    </script>
  </head>
  <body>
    <header>ãƒŸãƒ­ã‚¹ãƒˆãƒ«æŠ€è¡“ç¤¾ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ / ãƒŸãƒ­ã‚¹ãƒˆãƒ«é€šä¿¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</header>
    <h1>ãƒŸãƒ­ã‚¹ãƒˆãƒ«ç°¡æ˜“ç‹¬ç«‹é›»å­ãƒ¡ãƒ¼ãƒ«</h1>
    <p>é–¢ä¿‚è€…ä»¥å¤–ã¯é–²è¦§ã‚’ãŠã‚„ã‚ãã ã•ã„</p>

    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:<br>
    <input type="text" id="accountname"><br>
    <span style="color: red; background: yellow;">
      <ruby>æ³¨æ„<rt>ã¡ã‚…ã†ã„</rt></ruby>ï¼<ruby>æ™‚é–“å¤–<rt>ã˜ã‹ã‚“ãŒã„</rt></ruby>ã«ã¯<ruby>çµ¶å¯¾<rt>ãœã£ãŸã„</rt></ruby>ã«æŠ¼ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚æŠ¼ã™ã®ã¯1å›ã ã‘ï¼
      <button id="con">æ¥ç¶š</button>
    </span>
    <br><br>

    é€ä¿¡å…ˆ:<br>
    <input type="text" id="towho" placeholder="å®›å…ˆã®ãƒˆãƒ”ãƒƒã‚¯">
    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:<br>
    <input type="text" id="sendwhat" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹">
    <button id="send">é€ä¿¡</button>

    <h3>å—ä¿¡ãƒ­ã‚°</h3>
    <div id="sounyuuhtml" style="border:1px solid #ccc; padding:10px; width:500px; height:200px; overflow:auto;"></div>

    <br><a href="https://bobcat1304.github.io/index.html">ãƒ›ãƒ¼ãƒ </a>
    <address>
      é€£çµ¡å…ˆ<br>
      é›»å­ãƒ¡ãƒ¼ãƒ« takikawatouma@gmail.com<br>
      å°å­¦æ ¡ 6å¹´3çµ„15ç•ª
    </address>

    <script>
      let mqttClient = null;
      let acname = "";

      // æ¥ç¶šãƒœã‚¿ãƒ³
      document.getElementById("con").addEventListener("click", function() {
        acname = document.getElementById("accountname").value.trim();
        if (!acname) return alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        mqttClient = createMQTTClient({
          brokerUrl: "wss://msimindmail.cloud.shiftr.io:443", // WebSocket + ãƒãƒ¼ãƒˆæŒ‡å®š
          username: "msimindmail",
          password: "kuati-saminamu",
          clientId: acname || "client_" + Math.random().toString(16).substr(2, 8)
        });

        // æ¥ç¶šå®Œäº†å¾Œã«è‡ªåˆ†ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­
        mqttClient.client.on("connect", () => {
          mqttClient.subscribe(acname, function(message, topic) {
            const log = document.getElementById("sounyuuhtml");
            log.innerHTML += message + "<br><br>";
            log.scrollTop = log.scrollHeight; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          });
        });
      });

      // é€ä¿¡ãƒœã‚¿ãƒ³
      document.getElementById("send").addEventListener("click", function() {
        if (!mqttClient) {
          alert("å…ˆã«æ¥ç¶šã—ã¦ãã ã•ã„");
          return;
        }

        const topic = document.getElementById("towho").value.trim();
        const message = document.getElementById("sendwhat").value.trim();

        if (!topic || !message) return alert("å®›å…ˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        mqttClient.publish(topic, message);
      });
    </script>
  </body>
</html>
