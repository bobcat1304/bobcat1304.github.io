<!DOCTYPE html>
<html>
  <head>
    <title>ãƒŸãƒ­ã‚¹ãƒˆãƒ«æŠ€è¡“ç¤¾ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
    /**
     * MQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
     * @param {Object} options
     * @param {string} options.brokerUrl ä¾‹: "wss://broker.hivemq.com:8884/mqtt"
     * @param {string} options.username
     * @param {string} options.password
     * @param {string} options.clientId
     * @returns {Object}
     */
    function createMQTTClient({ brokerUrl, username, password, clientId }) {
      const client = mqtt.connect(brokerUrl, {
        username: username,
        password: password,
        clientId: clientId,
        clean: true,
        reconnectPeriod: 1000
      });
    
      client.on("connect", () => {
        console.log("âœ… MQTTæ¥ç¶šæˆåŠŸ");
      });
    
      client.on("error", (err) => {
        console.error("âŒ MQTTã‚¨ãƒ©ãƒ¼:", err);
      });
    
      client.on("reconnect", () => {
        console.log("ğŸ”„ å†æ¥ç¶šä¸­...");
      });
    
      return {
        /**
         * ãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­ã™ã‚‹
         * @param {string} topic
         * @param {Function} callback (message, topic) => {}
         */
        subscribe(topic, callback) {
          client.subscribe(topic, (err) => {
            if (err) {
              console.error("âŒ è³¼èª­å¤±æ•—:", err);
            } else {
              console.log("ğŸ“¡ è³¼èª­æˆåŠŸ:", topic);
            }
          });
    
          client.on("message", (recvTopic, message) => {
            if (recvTopic === topic) {
              callback(message.toString(), recvTopic);
            }
          });
        },
    
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç™ºè¡Œã™ã‚‹
         * @param {string} topic
         * @param {string} message
         */
        publish(topic, message) {
          client.publish(topic, message, {}, (err) => {
            if (err) {
              console.error("âŒ ç™ºè¡Œå¤±æ•—:", err);
            } else {
              console.log("ğŸ“¤ ç™ºè¡ŒæˆåŠŸ:", topic, message);
            }
          });
        },
    
        /**
         * åˆ‡æ–­
         */
        disconnect() {
          client.end();
          console.log("ğŸ”Œ åˆ‡æ–­ã—ã¾ã—ãŸ");
        }
      };
    }
    </script>
  </head>
  <body>
    <header>ãƒŸãƒ­ã‚¹ãƒˆãƒ«æŠ€è¡“ç¤¾ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ/ãƒŸãƒ­ã‚¹ãƒˆãƒ«é€šä¿¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</header>
    <h1>ãƒŸãƒ­ã‚¹ãƒˆãƒ«ç°¡æ˜“ç‹¬ç«‹é›»å­ãƒ¡ãƒ¼ãƒ«</h1>
    <p>é–¢ä¿‚è€…ä»¥å¤–ã¯é–²è¦§ã‚’ãŠã‚„ã‚ãã ã•ã„</p>
    èª¬æ˜<br>
    ã€Œç‹¬ç«‹ã€ã£ã¦ã„ã†ã®ã¯ã€Gmailã¨ã‹Yahoo!ãƒ¡ãƒ¼ãƒ«ã¨é•ã£ã¦ã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã—ã‹ãƒ¡ãƒ¼ãƒ«ã‚’é€å—ä¿¡ã§ããªã„ã£ã¦ã„ã†ã“ã¨ã€‚<br><br><br><br><br>
    <input type="text" id="accountname"><br>
    <span style="color: red; background: yellow;"><ruby>æ³¨æ„<rt>ã¡ã‚…ã†ã„</rt></ruby>ï¼<ruby>æ™‚é–“å¤–<rt>ã˜ã‹ã‚“ãŒã„</rt></ruby>ã«ã¯<ruby>çµ¶å¯¾<rt>ãœã£ãŸã„</rt></ruby>ã«<ruby>æŠ¼<rt>ãŠ</rt></ruby>ã—ã¦ã¯ã„ã‘ãªã„ã€‚<button id="con">æ¥ç¶š</button>ã¯ã‚„ã™ãã‚‚ ãŠãã™ãã‚‚ ã ã‚ã§ã™ï¼</span><br><br><br><br>
    <input type="text" id="sendwhat"><button id="send">é€ä¿¡</button>
    <a href="https://bobcat1304.github.io/index.html">ãƒ›ãƒ¼ãƒ </a>
    <address>
      é€£çµ¡å…ˆ<br>
      é›»å­ãƒ¡ãƒ¼ãƒ« takikawatouma@gmail.com<br>
      å°å­¦æ ¡ 6å¹´3çµ„15ç•ª
    </address>
    <script>
    let mqttClient = null;   // â† å¤–ã«å‡ºã™
    let acname = "";         // â† å¤–ã«å‡ºã™
    
    document.getElementById("con").addEventListener("click", function() {
      acname = document.getElementById("accountname").value;
    
      mqttClient = createMQTTClient({
        brokerUrl: "wss://msimindmail.cloud.shiftr.io",
        username: "msimindmail",
        password: "kuati-saminamu",
        clientId: acname
      });
    });
    
    document.getElementById("send").addEventListener("click", function () {
    
      if (!mqttClient) {
        alert("å…ˆã«æ¥ç¶šã—ã¦ãã ã•ã„");
        return;
      }
    
      const topic = acname;
      const message = document.getElementById("sendwhat").value;
    
      mqttClient.publish(topic, message);
    });
    </script>

  </body>
</html>
